<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory - Izumi Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #111827;
            color: white;
        }
    </style>
</head>
<body>
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 min-h-screen">
            <nav class="p-6">
                <h2 class="text-xl font-bold mb-6">Izumi Inventory</h2>
                <ul class="space-y-3">
                    <li><a href="dashboard.html" class="block p-2 rounded hover:bg-gray-700">Dashboard</a></li>
                    <li><a href="inventory.html" class="block p-2 rounded bg-blue-600">Inventory</a></li>
                    <li><a href="products.html" class="block p-2 rounded hover:bg-gray-700">Products</a></li>
                    <li><a href="categories.html" class="block p-2 rounded hover:bg-gray-700">Categories</a></li>
                    <li><a href="settings.html" class="block p-2 rounded hover:bg-gray-700">Settings</a></li>
                    <li><a href="index.html" class="text-red-400 block p-2 rounded hover:bg-gray-700 mt-8">Logout</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">Inventory Management</h1>
                <div class="flex items-center">
                    <input type="text" id="searchInventory" placeholder="Search inventory..." 
                        class="bg-gray-700 border border-gray-600 rounded-lg text-white px-3 py-2 mr-4 focus:outline-none focus:border-blue-500">
                    <button id="exportInventoryBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg mr-2">Export</button>
                </div>
            </div>
            
            <!-- Inventory List -->
            <div class="bg-gray-800 rounded-xl border border-gray-700 p-6">
                <div class="overflow-x-auto">
                    <!-- Update the table header in the Inventory List section -->
                    <table class="min-w-full" id="inventoryTable">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="text-left py-3 px-4">Product Name</th>
                                <th class="text-left py-3 px-4">SKU</th>
                                <th class="text-left py-3 px-4">Quantity</th>
                                <th class="text-left py-3 px-4">Status</th>
                                <th class="text-left py-3 px-4">Last Updated</th>
                                <th class="text-left py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Inventory items will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Update Stock Modal -->
    <div id="updateStockModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Update Stock</h2>
            <form id="updateStockForm" class="space-y-4">
                <input type="hidden" id="updateProductId">
                <div>
                    <p id="updateProductName" class="font-medium mb-2"></p>
                    <p id="updateProductSku" class="text-gray-400 text-sm mb-4"></p>
                </div>
                <div>
                    <label for="currentStock" class="block text-sm font-medium text-gray-400">Current Stock</label>
                    <input type="number" id="currentStock" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" readonly>
                </div>
                <div>
                    <label for="stockChange" class="block text-sm font-medium text-gray-400">Add/Remove Stock</label>
                    <div class="flex items-center mt-1">
                        <button type="button" id="decreaseStock" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded-l-lg">-</button>
                        <input type="number" id="stockChange" class="block w-full px-3 py-2 bg-gray-700 border-y border-gray-600 text-white text-center" value="0">
                        <button type="button" id="increaseStock" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-r-lg">+</button>
                    </div>
                </div>
                <div>
                    <label for="newStock" class="block text-sm font-medium text-gray-400">New Stock Level</label>
                    <input type="number" id="newStock" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" readonly>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelUpdateStock" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">Update Stock</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Edit Product Modal -->
    <div id="editProductModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Edit Product</h2>
            <form id="editProductForm" class="space-y-4">
                <div>
                    <label for="editName" class="block text-sm font-medium text-gray-400">Product Name</label>
                    <input type="text" id="editName" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                </div>
                <div>
                    <label for="editSku" class="block text-sm font-medium text-gray-400">SKU</label>
                    <input type="text" id="editSku" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" readonly>
                </div>
                <div>
                    <label for="editCategory" class="block text-sm font-medium text-gray-400">Category</label>
                    <input type="text" id="editCategory" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                </div>
                <div>
                    <label for="editPrice" class="block text-sm font-medium text-gray-400">Price</label>
                    <input type="number" id="editPrice" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" step="0.01">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelEditProduct" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Load inventory from localStorage
        // Update the loadInventory function to properly fetch and display inventory data
        // Add this function to refresh the inventory data
        async function loadInventory() {
            try {
                const response = await fetch('http://localhost:3003/api/inventory');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const inventory = await response.json();
                
                const tbody = document.querySelector('#inventoryTable tbody');
                tbody.innerHTML = '';
        
                if (!inventory || inventory.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="py-3 px-4 text-center">No inventory found</td></tr>';
                    return;
                }
        
                inventory.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700';
                    
                    // Determine status based on quantity
                    let status = 'In Stock';
                    if (item.quantity <= 0) {
                        status = 'Out of Stock';
                    }
                    
                    // Format date
                    const lastUpdated = item.last_updated ? new Date(item.last_updated).toLocaleDateString() : '-';
                    
                    row.innerHTML = `
                        <td class="py-3 px-4">${item.name}</td>
                        <td class="py-3 px-4">${item.sku}</td>
                        <td class="py-3 px-4">${item.quantity || 0}</td>
                        <td class="py-3 px-4">
                            ${status === 'Out of Stock' 
                                ? `<span class="px-2 py-1 bg-red-900 text-red-300 rounded-full text-xs font-medium">Out of Stock</span>` 
                                : `<span class="px-2 py-1 bg-green-900 text-green-300 rounded-full text-xs font-medium">In Stock</span>`
                            }
                        </td>
                        <td class="py-3 px-4">${lastUpdated}</td>
                        <td class="py-3 px-4">
                            <button class="update-stock-btn text-blue-400 hover:text-blue-300 mr-2">Update Stock</button>
                            <button class="edit-btn text-blue-400 hover:text-blue-300 mr-2">Edit</button>
                            <button class="delete-btn text-red-400 hover:text-red-300">Delete</button>
                        </td>
                    `;
                    
                    // Update edit button listener
                    const editBtn = row.querySelector('.edit-btn');
                    editBtn.addEventListener('click', function() {
                        document.getElementById('editName').value = item.name;
                        document.getElementById('editSku').value = item.sku;
                        document.getElementById('editCategory').value = item.category;
                        document.getElementById('editPrice').value = item.price;
                        document.getElementById('editProductModal').classList.remove('hidden');
                    });
                    
                    // Add edit modal event listeners
                    // Remove these event listeners from the forEach loop and add them here, after loadInventory function
                    document.getElementById('cancelEditProduct').addEventListener('click', function() {
                        document.getElementById('editProductModal').classList.add('hidden');
                    });
                    
                    // Update the edit form submission handler
                    document.getElementById('editProductForm').addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        const sku = document.getElementById('editSku').value.trim();
                        const updatedProduct = {
                            name: document.getElementById('editName').value.trim(),
                            sku: sku,
                            category: document.getElementById('editCategory').value.trim(),
                            price: parseFloat(document.getElementById('editPrice').value) || 0
                        };
                        
                        try {
                            const response = await fetch(`http://localhost:3002/api/products/${encodeURIComponent(sku)}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(updatedProduct)
                            });
                    
                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error || 'Failed to update product');
                            }
                    
                            // Hide modal
                            document.getElementById('editProductModal').classList.add('hidden');
                            
                            // Reload inventory to show updated values
                            await loadInventory();
                            
                            alert('Product updated successfully!');
                        } catch (error) {
                            console.error('Error updating product:', error);
                            alert('Failed to update product: ' + error.message);
                        }
                    });
                    
                    // Update the delete button event listener
                    const deleteBtn = row.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', async function() {
                        if (confirm('Are you sure you want to delete this item?')) {
                            try {
                                const response = await fetch(`http://localhost:3002/api/products/${item.sku}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });
                                
                                if (!response.ok) {
                                    const data = await response.json();
                                    throw new Error(data.error || 'Failed to delete item');
                                }
                                
                                await loadInventory(); // Reload the inventory
                                alert('Item deleted successfully');
                            } catch (error) {
                                console.error('Error deleting item:', error);
                                alert(error.message);
                            }
                        }
                    });
                    
                    // Add click handler to the Update Stock button
                    const updateBtn = row.querySelector('.update-stock-btn');
                    updateBtn.addEventListener('click', function() {
                        // Set modal values
                        document.getElementById('updateProductName').textContent = item.name;
                        document.getElementById('updateProductSku').textContent = `SKU: ${item.sku}`;
                        document.getElementById('currentStock').value = item.quantity || 0;
                        document.getElementById('stockChange').value = 0;
                        document.getElementById('newStock').value = item.quantity || 0;
                        
                        // Show modal
                        document.getElementById('updateStockModal').classList.remove('hidden');
                    });
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error:', error);
                const tbody = document.querySelector('#inventoryTable tbody');
                tbody.innerHTML = `<tr><td colspan="6" class="py-3 px-4 text-center text-red-500">Error loading inventory: ${error.message}</td></tr>`;
            }
        }
        
        // Open update stock modal
        function openUpdateStockModal() {
            const row = this.closest('tr');
            const productId = row.dataset.id;
            
            // Get inventory item
            const inventory = JSON.parse(localStorage.getItem('izumiInventory') || '[]');
            const item = inventory.find(i => i.productId === productId);
            
            if (item) {
                document.getElementById('updateProductId').value = productId;
                document.getElementById('updateProductName').textContent = item.productName;
                document.getElementById('updateProductSku').textContent = `SKU: ${item.sku}`;
                document.getElementById('currentStock').value = item.quantity;
                document.getElementById('stockChange').value = 0;
                document.getElementById('newStock').value = item.quantity;
                
                document.getElementById('updateStockModal').classList.remove('hidden');
            }
        }
        
        // Handle stock change
        document.getElementById('stockChange').addEventListener('input', updateNewStockValue);
        document.getElementById('increaseStock').addEventListener('click', function() {
            const stockChange = document.getElementById('stockChange');
            stockChange.value = parseInt(stockChange.value || 0) + 1;
            updateNewStockValue();
        });
        document.getElementById('decreaseStock').addEventListener('click', function() {
            const stockChange = document.getElementById('stockChange');
            stockChange.value = parseInt(stockChange.value || 0) - 1;
            updateNewStockValue();
        });
        
        function updateNewStockValue() {
            const currentStock = parseInt(document.getElementById('currentStock').value || 0);
            const stockChange = parseInt(document.getElementById('stockChange').value || 0);
            document.getElementById('newStock').value = currentStock + stockChange;
        }
        
        // Cancel update stock
        document.getElementById('cancelUpdateStock').addEventListener('click', function() {
            document.getElementById('updateStockModal').classList.add('hidden');
        });
        
        // Update stock form submission handler
        document.getElementById('updateStockForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const sku = document.getElementById('updateProductSku').textContent.replace('SKU: ', '');
            const stockChange = parseInt(document.getElementById('stockChange').value);
            
            try {
                const response = await fetch('http://localhost:3002/api/inventory/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sku: sku,
                        quantity: stockChange
                    })
                });
        
                if (!response.ok) {
                    throw new Error('Failed to update stock');
                }
        
                // Hide modal and clear form
                document.getElementById('updateStockModal').classList.add('hidden');
                document.getElementById('stockChange').value = '0';
                
                // Reload inventory to show updated values
                await loadInventory();
                
                alert('Stock updated successfully!');
            } catch (error) {
                console.error('Error updating stock:', error);
                alert('Failed to update stock: ' + error.message);
            }
        });
        
        // Search functionality
        document.getElementById('searchInventory').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#inventoryTable tbody tr');
            
            rows.forEach(row => {
                const productName = row.cells[0].textContent.toLowerCase();
                const sku = row.cells[1].textContent.toLowerCase();
                
                if (productName.includes(searchTerm) || sku.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Export functionality
        document.getElementById('exportInventoryBtn').addEventListener('click', function() {
            const inventory = JSON.parse(localStorage.getItem('izumiInventory') || '[]');
            
            // Create CSV content
            let csvContent = 'Product Name,SKU,Quantity,Status,Last Updated\n';
            
            inventory.forEach(item => {
                let status;
                if (item.quantity <= 0) {
                    status = 'Out of Stock';
                } else if (item.quantity < 5) {
                    status = 'Low Stock';
                } else {
                    status = 'In Stock';
                }
                
                const lastUpdated = new Date(item.lastUpdated).toLocaleString();
                
                csvContent += `"${item.productName}","${item.sku}",${item.quantity},"${status}","${lastUpdated}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'inventory_export.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Load inventory on page load
        document.addEventListener('DOMContentLoaded', loadInventory);
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const sku = urlParams.get('sku');
            const productName = urlParams.get('name');
            
            // If we have SKU parameter, show the update stock modal
            if (sku && productName) {
                const updateStockModal = document.getElementById('updateStockModal');
                document.getElementById('updateStockProductName').textContent = `Update stock for: ${productName}`;
                updateStockModal.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>

// Add this function to handle stock updates
async function updateStock(productId, newQuantity) {
    try {
        const response = await fetch(`http://localhost:3003/api/inventory/${productId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ quantity: newQuantity })
        });

        if (!response.ok) {
            throw new Error('Failed to update stock');
        }

        // Reload inventory to show updated quantities
        loadInventory();
        
        // Close the modal
        const modal = document.getElementById('updateStockModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error updating stock:', error);
        alert('Failed to update stock: ' + error.message);
    }
}

// Add event listener for the Update Stock button in the modal
document.querySelector('#updateStockBtn').addEventListener('click', async function() {
    const newStockLevel = document.querySelector('#newStockLevel').value;
    const productId = this.getAttribute('data-product-id');
    
    if (newStockLevel !== '') {
        try {
            const response = await fetch(`http://localhost:3003/api/inventory/${productId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ quantity: parseInt(newStockLevel) })
            });

            if (!response.ok) {
                throw new Error('Failed to update stock');
            }

            // Close the modal
            const modal = document.getElementById('updateStockModal');
            modal.classList.add('hidden');

            // Refresh the inventory display
            await loadInventory();

        } catch (error) {
            console.error('Error updating stock:', error);
            alert('Failed to update stock: ' + error.message);
        }
    }
});

// Add/Remove stock buttons functionality
document.querySelector('.subtract-stock').addEventListener('click', function() {
    const input = document.querySelector('#stockChange');
    const currentValue = parseInt(input.value) || 0;
    if (currentValue > 0) {
        input.value = currentValue - 1;
        updateNewStockLevel();
    }
});

document.querySelector('.add-stock').addEventListener('click', function() {
    const input = document.querySelector('#stockChange');
    const currentValue = parseInt(input.value) || 0;
    input.value = currentValue + 1;
    updateNewStockLevel();
});

// Update the new stock level based on current stock and change
function updateNewStockLevel() {
    const currentStock = parseInt(document.querySelector('#currentStock').value) || 0;
    const stockChange = parseInt(document.querySelector('#stockChange').value) || 0;
    document.querySelector('#newStockLevel').value = currentStock + stockChange;
}